name: Auto Run Dify Workflow with Logs

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 8 ç‚¹æ‰§è¡Œ (UTC æ—¶é—´ï¼Œè¯·æ¢ç®—ä¸ºæœ¬åœ°æ—¶åŒº)
    - cron: "50 23 * * *"
  workflow_dispatch:  # å¯æ‰‹åŠ¨è§¦å‘

jobs:
  run-dify-workflow:
    runs-on: ubuntu-latest
    env:
      DIFY_BASE_URL: ${{ secrets.DIFY_BASE_URL }}
      DIFY_TOKENS: ${{ secrets.DIFY_TOKENS }}
      DIFY_INPUTS: ${{ secrets.DIFY_INPUTS }}

    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: è°ƒç”¨ Dify å·¥ä½œæµ API
        id: call_api
        run: |
          echo "ðŸš€ æ­£åœ¨è°ƒç”¨ Dify å·¥ä½œæµ: $DIFY_BASE_URL"
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $DIFY_TOKENS" \
            -H "Content-Type: application/json" \
            -d "$DIFY_INPUTS" \
            "$DIFY_BASE_URL")

          http_status=$(echo "$response" | sed -n 's/HTTP_STATUS://p')
          body=$(echo "$response" | sed '/HTTP_STATUS:/d')

          echo "status=$http_status" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$body" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ "$http_status" -ne 200 ]; then
            echo "âŒ Dify å·¥ä½œæµè°ƒç”¨å¤±è´¥"
            exit 1
          else
            echo "âœ… Dify å·¥ä½œæµè°ƒç”¨æˆåŠŸï¼"
          fi

      - name: ä¿å­˜æ—¥å¿—åˆ°ä»“åº“
        run: |
          mkdir -p logs
          timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "==== $timestamp ====" >> logs/dify_run.log
          echo "Status: ${{ steps.call_api.outputs.status }}" >> logs/dify_run.log
          echo "Response: ${{ steps.call_api.outputs.body }}" >> logs/dify_run.log
          echo "" >> logs/dify_run.log

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add logs/dify_run.log
          git commit -m "Update Dify run log: $timestamp" || echo "No changes to commit"
          git push origin HEAD:${GITHUB_REF}

