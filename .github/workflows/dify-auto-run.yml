name: Auto Run Dify Workflow

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 8 ç‚¹æ‰§è¡Œä¸€æ¬¡ (UTC æ—¶é—´ï¼Œè¯·æ¢ç®—ä¸ºä½ çš„æ—¶åŒº)
    - cron: "0 8 * * *"
  workflow_dispatch:  # ä¹Ÿå…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  run-dify-workflow:
    runs-on: ubuntu-latest
    env:
      DIFY_BASE_URL: ${{ secrets.DIFY_BASE_URL }}
      DIFY_TOKENS: ${{ secrets.DIFY_TOKENS }}
      DIFY_INPUTS: ${{ secrets.DIFY_INPUTS }}

    steps:
      - name: è°ƒç”¨ Dify å·¥ä½œæµ API
        run: |
          echo "ğŸš€ æ­£åœ¨è°ƒç”¨ Dify å·¥ä½œæµ: $DIFY_BASE_URL"
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $DIFY_TOKENS" \
            -H "Content-Type: application/json" \
            -d "$DIFY_INPUTS" \
            "$DIFY_BASE_URL")

          # æå– HTTP çŠ¶æ€ç 
          http_status=$(echo "$response" | sed -n 's/HTTP_STATUS://p')
          body=$(echo "$response" | sed '/HTTP_STATUS:/d')

          echo "è¿”å›çŠ¶æ€ç : $http_status"
          echo "è¿”å›å†…å®¹: $body"

          if [ "$http_status" -ne 200 ]; then
            echo "âŒ Dify å·¥ä½œæµè°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ BASE_URL / TOKEN / INPUTS"
            exit 1
          else
            echo "âœ… Dify å·¥ä½œæµè°ƒç”¨æˆåŠŸï¼"
          fi
