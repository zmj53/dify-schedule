name: Auto Run Dify Workflow2

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 8 ç‚¹æ‰§è¡Œä¸€æ¬¡ (UTC æ—¶é—´ï¼Œè¯·æ¢ç®—ä¸ºä½ çš„æ—¶åŒº)
    - cron: "0 8 * * *"
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘è¿è¡Œ

jobs:
  run-dify-workflow:
    runs-on: ubuntu-latest
    env:
      DIFY_BASE_URL: ${{ secrets.DIFY_BASE_URL }}   # ä¾‹å¦‚ https://api.dify.ai/v1/workflows/<workflow_id>/execute
      DIFY_TOKENS: ${{ secrets.DIFY_TOKENS }}       # å·¥ä½œæµ / åº”ç”¨çš„ API Key
      DIFY_INPUTS: ${{ secrets.DIFY_INPUTS }}       # JSON è¾“å…¥å‚æ•°

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è°ƒç”¨ Dify å·¥ä½œæµ /execute API
        id: call_dify
        run: |
          echo "ğŸš€ æ­£åœ¨è°ƒç”¨ Dify å·¥ä½œæµ: $DIFY_BASE_URL"
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $DIFY_TOKENS" \
            -H "Content-Type: application/json" \
            -d "$DIFY_INPUTS" \
            "$DIFY_BASE_URL")

          # è§£æçŠ¶æ€ç å’Œ Body
          http_status=$(echo "$response" | sed -n 's/HTTP_STATUS://p')
          body=$(echo "$response" | sed '/HTTP_STATUS:/d')

          echo "çŠ¶æ€ç : $http_status"
          echo "è¿”å›å†…å®¹: $body"

          echo "status=$http_status" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$body" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ "$http_status" -ne 200 ]; then
            echo "âŒ Dify å·¥ä½œæµè°ƒç”¨å¤±è´¥"
            exit 1
          else
            echo "âœ… Dify å·¥ä½œæµè°ƒç”¨æˆåŠŸ"
          fi

      - name: ä¿å­˜æ—¥å¿—åˆ°ä»“åº“
        run: |
          mkdir -p logs
          timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "==== $timestamp ====" >> logs/dify_run.log
          echo "API URL: $DIFY_BASE_URL" >> logs/dify_run.log
          echo "Status: ${{ steps.call_dify.outputs.status }}" >> logs/dify_run.log
          echo "Response: ${{ steps.call_dify.outputs.body }}" >> logs/dify_run.log
          echo "" >> logs/dify_run.log

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add logs/dify_run.log
          git commit -m "Update Dify run log: $timestamp" || echo "âš ï¸ æ— å˜æ›´å¯æäº¤"
          git push origin HEAD:${GITHUB_REF}
